# Container Security Scanning for Fragrance Rater
# Scans Docker images for vulnerabilities using Trivy and lints Dockerfile with Hadolint.
#
# This is a thin caller to the org-level reusable workflow.
name: Container Security

on:
  push:
    branches: [main, master]
    paths:
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - 'pyproject.toml'
      - 'uv.lock'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - 'pyproject.toml'
      - 'uv.lock'
  schedule:
    # Weekly scan on Wednesdays at 7 AM UTC
    - cron: '0 7 * * 3'
  workflow_dispatch:

# Cancel in-progress runs for same PR/branch
concurrency:
  group: container-security-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  packages: read

jobs:
  container-security:
    name: Container Security Scan
    uses: ByronWilliamsCPA/.github/.github/workflows/python-container-security.yml@main
    with:
      dockerfile-path: 'Dockerfile'
      build-context: '.'
      image-tag: 'fragrance_rater:scan'
      build-image: true
      severity-threshold: 'CRITICAL,HIGH'
      fail-on-vulnerabilities: true
      run-hadolint: true
      hadolint-failure-threshold: 'warning'
      generate-sbom: true
      upload-sarif: true
      artifact-retention-days: 90
    secrets: inherit
